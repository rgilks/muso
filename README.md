# muso

A tiny generative ambient synth for the browser powered by Rust DSP compiled to WebAssembly, an AudioWorklet, and a Next.js UI.

- **Frontend**: Next.js 15, React 19, Tailwind CSS 4
- **DSP**: Rust crates compiled to WASM (`dsp`, `worklet`)
- **Audio**: Web Audio API + AudioWorklet
- **Deploy**: Cloudflare Pages/Workers via `@cloudflare/next-on-pages` + `wrangler`

## Quick start

Prereqs:

- Node.js 20+
- Rust toolchain (`rustup`)
- wasm-pack (either `cargo install wasm-pack` or the official installer)
- Wrangler CLI for Cloudflare: `npm i -g wrangler` (or use the local dev dependency via npx)

Install and run:

```bash
# install deps
npm install

# build the Rust → WASM artifacts (outputs to public/)
npm run build:wasm

# start Next.js dev server
npm run dev
```

Open http://localhost:3000 and press Start to allow audio. Use the sliders and sequencer to shape the sound.

## Scripts

```json
{
  "dev": "next dev --turbopack",
  "build": "next build",
  "start": "next start",
  "lint": "next lint",
  "build:wasm": "wasm-pack build dsp --target web --out-dir ../public/dsp --release && wasm-pack build worklet --target web --out-dir ../public/worklet --release",
  "build:cf": "npm run build:wasm && npx @cloudflare/next-on-pages",
  "preview:cf": "npx wrangler dev --local",
  "deploy:cf": "npx wrangler deploy"
}
```

- **dev**: Next.js dev server with Turbopack
- **build**: Next.js production build
- **start**: Run the production server
- **lint**: Lint the app
- **build:wasm**: Compile Rust crates to WASM, emitting to `public/dsp` and `public/worklet`
- **build:cf**: Build WASM then produce a Cloudflare-compatible output in `.vercel/output` via `next-on-pages`
- **preview:cf**: Local Cloudflare dev of the produced worker/site
- **deploy:cf**: Deploy to Cloudflare

## Architecture

- `src/app/ui/ClientAmbient.tsx`
  - Sets up `AudioContext`, loads the `dsp` WASM bundle, registers the AudioWorklet, and streams audio blocks by responding to pull messages from the worklet.
  - Renders a responsive canvas visualization and UI controls (BPM, reverb mix/width, LPF, resonance, volume, 16‑step sequencer, randomize).
- `dsp` (Rust crate)
  - Real-time audio engine: drone oscillators, pink noise bed, envelopes, sequencer timing, stereo Freeverb‑style reverb, soft clipping, autopan.
  - Exported with `wasm-bindgen` and consumed directly from the UI.
- `worklet` (Rust crate)
  - Thin placeholder layer compiled to WASM; the actual DSP runs in the main thread module for simplicity while the AudioWorklet coordinates pull‑based buffering.
- `public/dsp` and `public/worklet`
  - Generated by `npm run build:wasm` (e.g., `dsp_bg.wasm`, `dsp.js`, `processor.js` if present).
- Cloudflare
  - `@cloudflare/next-on-pages` outputs a static worker bundle under `.vercel/output`.
  - `wrangler.toml` binds assets and configures routes.

## Project layout

```
muso/
  src/app/              # Next.js App Router
    ui/ClientAmbient.tsx
  dsp/                  # Rust DSP crate → WASM
    src/lib.rs
  worklet/              # Rust AudioWorklet helper → WASM
    src/lib.rs
  public/               # Static assets and emitted WASM bundles
    dsp/
    worklet/
  .vercel/output/       # Built by next-on-pages (after build:cf)
  wrangler.toml         # Cloudflare Workers/Pages config
```

## Local development

1. Build WASM once (rebuild when Rust changes):

```bash
npm run build:wasm
```

2. Start the app:

```bash
npm run dev
```

3. Open http://localhost:3000 and click Start (browser user gesture is required to begin audio).

Optional: lint/typecheck

```bash
npm run lint
```

## Building for production

Standard Next.js build:

```bash
npm run build
```

Run locally in prod mode:

```bash
npm run start
```

## Cloudflare deployment

Build the Cloudflare output, then deploy:

```bash
# produce .vercel/output via next-on-pages
npm run build:cf

# optional: local preview
npm run preview:cf

# first time: authenticate
npx wrangler login

# deploy
npm run deploy:cf
```

Routing and asset bindings are configured in `wrangler.toml`. The worker serves `.vercel/output/static` with nodejs_compat enabled.

## Troubleshooting

- **No sound / Start does nothing**
  - Ensure you clicked Start; browsers block audio until a user gesture.
  - Check Console for network errors loading `/dsp/dsp.js` or `/dsp/dsp_bg.wasm`. If missing, run `npm run build:wasm`.
  - On iOS/Safari, make sure the page is served over HTTPS and Low Power Mode isn’t throttling audio.
- **WASM changes not reflected**
  - Re-run `npm run build:wasm` and restart the dev server. Clear the browser cache if needed.
- **Worklet init errors**
  - Confirm `/worklet/processor.js` is accessible. If you maintain a custom processor, ensure it’s emitted under `public/worklet/`.
- **Cloudflare build issues**
  - Delete `.vercel/output` and re-run `npm run build:cf`.
  - Make sure you’re on Node 20+ and Wrangler 4.x.

## Tech notes

- `wasm-bindgen` generates the JS glue for calling into Rust.
- Audio runs at 48 kHz by default in the app to match many devices and reduce resampling.
- The sequencer advances on 16th‑note steps computed from BPM and sample rate.

## License

Add your preferred license. If you intend to open-source, drop a `LICENSE` file in the repo root.
